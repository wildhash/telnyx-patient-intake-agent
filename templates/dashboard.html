<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Telnyx Patient Intake Agent</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
        }
        
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 40px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .navbar h1 {
            font-size: 1.8em;
        }
        
        .container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 0 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .stat-card h3 {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        
        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }
        
        .section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }
        
        .section h2 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-success {
            background: #48bb78;
            color: white;
        }
        
        .btn-success:hover {
            background: #38a169;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #666;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .badge-success {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .badge-warning {
            background: #fef3c7;
            color: #78350f;
        }
        
        .badge-danger {
            background: #fecaca;
            color: #7f1d1d;
        }
        
        .badge-info {
            background: #dbeafe;
            color: #1e3a8a;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1em;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
        }
        
        .modal-content h3 {
            margin-bottom: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>ðŸ“Š Patient Intake Dashboard</h1>
    </div>
    
    <div class="container">
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <h3>Total Patients</h3>
                <div class="value" id="totalPatients">-</div>
            </div>
            <div class="stat-card">
                <h3>Total Calls</h3>
                <div class="value" id="totalCalls">-</div>
            </div>
            <div class="stat-card">
                <h3>Completed Calls</h3>
                <div class="value" id="completedCalls">-</div>
            </div>
            <div class="stat-card">
                <h3>Active Calls</h3>
                <div class="value" id="activeCalls">-</div>
            </div>
            <div class="stat-card">
                <h3>Consent Rate</h3>
                <div class="value" id="consentRate">-</div>
            </div>
        </div>
        
        <div class="section">
            <h2>Quick Actions</h2>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openNewCallModal()">ðŸ“ž Initiate New Call</button>
                <button class="btn btn-success" onclick="openNewPatientModal()">âž• Add Patient</button>
                <button class="btn btn-primary" onclick="window.location.href='/dashboard/calls'">ðŸ“‹ View All Calls</button>
                <button class="btn btn-primary" onclick="window.location.href='/dashboard/patients'">ðŸ‘¥ View All Patients</button>
            </div>
        </div>
        
        <div class="section">
            <h2>Recent Calls</h2>
            <div id="recentCalls" class="loading">Loading...</div>
        </div>
    </div>
    
    <!-- New Call Modal -->
    <div id="newCallModal" class="modal">
        <div class="modal-content">
            <h3>Initiate New Call</h3>
            <form id="newCallForm">
                <div class="form-group">
                    <label for="phoneNumber">Phone Number *</label>
                    <input type="tel" id="phoneNumber" required placeholder="+1234567890">
                </div>
                <div class="form-group">
                    <label for="patientId">Patient ID (optional)</label>
                    <input type="number" id="patientId" placeholder="Leave empty to auto-create">
                </div>
                <div class="action-buttons">
                    <button type="submit" class="btn btn-primary">Start Call</button>
                    <button type="button" class="btn" onclick="closeNewCallModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- New Patient Modal -->
    <div id="newPatientModal" class="modal">
        <div class="modal-content">
            <h3>Add New Patient</h3>
            <form id="newPatientForm">
                <div class="form-group">
                    <label for="patientPhone">Phone Number *</label>
                    <input type="tel" id="patientPhone" required placeholder="+1234567890">
                </div>
                <div class="form-group">
                    <label for="patientFirstName">First Name</label>
                    <input type="text" id="patientFirstName" placeholder="John">
                </div>
                <div class="form-group">
                    <label for="patientLastName">Last Name</label>
                    <input type="text" id="patientLastName" placeholder="Doe">
                </div>
                <div class="form-group">
                    <label for="patientEmail">Email</label>
                    <input type="email" id="patientEmail" placeholder="john@example.com">
                </div>
                <div class="action-buttons">
                    <button type="submit" class="btn btn-success">Create Patient</button>
                    <button type="button" class="btn" onclick="closeNewPatientModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // Load statistics
        function loadStats() {
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('totalPatients').textContent = data.total_patients;
                    document.getElementById('totalCalls').textContent = data.total_calls;
                    document.getElementById('completedCalls').textContent = data.completed_calls;
                    document.getElementById('activeCalls').textContent = data.active_calls;
                    document.getElementById('consentRate').textContent = data.consent_rate + '%';
                })
                .catch(error => {
                    console.error('Error loading stats:', error);
                });
        }
        
        // Load recent calls
        function loadRecentCalls() {
            fetch('/api/calls?limit=10')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('recentCalls');
                    
                    if (data.total === 0) {
                        container.innerHTML = '<p>No calls yet. Initiate your first call above!</p>';
                        return;
                    }
                    
                    let html = '<table><thead><tr><th>ID</th><th>To</th><th>Status</th><th>Consent</th><th>Duration</th><th>Started</th></tr></thead><tbody>';
                    
                    data.calls.forEach(call => {
                        const statusClass = call.status === 'completed' ? 'success' : call.status === 'failed' ? 'danger' : 'info';
                        const consentClass = call.consent_given ? 'success' : 'warning';
                        
                        html += `<tr>
                            <td>${call.id}</td>
                            <td>${call.to_number}</td>
                            <td><span class="badge badge-${statusClass}">${call.status}</span></td>
                            <td><span class="badge badge-${consentClass}">${call.consent_given ? 'Yes' : 'No'}</span></td>
                            <td>${call.duration_seconds ? call.duration_seconds + 's' : 'N/A'}</td>
                            <td>${new Date(call.created_at).toLocaleString()}</td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table>';
                    container.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error loading calls:', error);
                    document.getElementById('recentCalls').innerHTML = '<p>Error loading calls</p>';
                });
        }
        
        // Modal functions
        function openNewCallModal() {
            document.getElementById('newCallModal').classList.add('active');
        }
        
        function closeNewCallModal() {
            document.getElementById('newCallModal').classList.remove('active');
            document.getElementById('newCallForm').reset();
        }
        
        function openNewPatientModal() {
            document.getElementById('newPatientModal').classList.add('active');
        }
        
        function closeNewPatientModal() {
            document.getElementById('newPatientModal').classList.remove('active');
            document.getElementById('newPatientForm').reset();
        }
        
        // Form submissions
        document.getElementById('newCallForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const data = {
                phone_number: document.getElementById('phoneNumber').value
            };
            
            const patientId = document.getElementById('patientId').value;
            if (patientId) {
                data.patient_id = parseInt(patientId);
            }
            
            fetch('/api/calls', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('Call initiated successfully! Call ID: ' + result.call_id);
                    closeNewCallModal();
                    loadStats();
                    loadRecentCalls();
                } else {
                    alert('Error: ' + (result.error || 'Failed to initiate call'));
                }
            })
            .catch(error => {
                alert('Error: ' + error.message);
            });
        });
        
        document.getElementById('newPatientForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const data = {
                phone_number: document.getElementById('patientPhone').value,
                first_name: document.getElementById('patientFirstName').value,
                last_name: document.getElementById('patientLastName').value,
                email: document.getElementById('patientEmail').value
            };
            
            fetch('/api/patients', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.id) {
                    alert('Patient created successfully! ID: ' + result.id);
                    closeNewPatientModal();
                    loadStats();
                } else {
                    alert('Error: ' + (result.error || 'Failed to create patient'));
                }
            })
            .catch(error => {
                alert('Error: ' + error.message);
            });
        });
        
        // Load data on page load
        loadStats();
        loadRecentCalls();
        
        // Refresh data every 30 seconds
        setInterval(() => {
            loadStats();
            loadRecentCalls();
        }, 30000);
    </script>
</body>
</html>
